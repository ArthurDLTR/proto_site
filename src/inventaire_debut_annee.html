<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="UTF-8">
        <meta content="width=device-width, initial-scale=1.0">
        <title>Prix d'achat pour les fournisseurs</title>
        <link rel="stylesheet" href="./altstyle.css">
        <script src="altscript.js"></script>
    </head>
    <body>  
        <div class="home-link">
            <div class="burger">
                <span class="first"></span>
                <span class="second"></span>
                <span class="third"></span>
            </div>
            <a href="/src/index.html">ECID SAS Chalicarne</a>
            <a href="/src/import_poids_volume.html">Protocole poids et volume</a>
            <a href="/src/import_prix_achat.html">Protocole fournisseur pour les prix d'achat</a>
            <a href="/src/import_prix_fourn.html">Protocole import prix fournisseur dans Dolibarr</a>
            <a href="/src/import_regles_remise.html">Protocole import r√®gles de remise dans Dolibarr</a>
            <a href="/src/inventaire_debut_annee.html">Inventaire de d√©but d'ann√©e</a>
        </div>
        <div class="lightdarkbutton">
            <div class="container">
                <div class="circle"></div>
            </div>
        </div>
        <div class="content">
            <h1 class="title">Inventaire de d√©but d'ann√©e</h1>

            <!-- Disclaimer -->
            <h2 class="sub-title">Protocole d√©cr√©pi ‚ö†Ô∏è</h2>
            <p class="text">Le protocole suivant fonctionne toujours mais Dolibarr dispose maintenant d'un outil int√©gr√© pour faire les inventaires comme d√©crit dans ce protocole.</p>
            <p class="text">Pour faire l'inventaire, il faut aller dans <b>Produits | Services</b> dans le menu √† gauche se trouve <b>Inventaire</b> et il suffit d'en cr√©er un nouveau.</p>
            <p class="text">Cette mani√®re de faire est bien plus simple et √©vite toutes erreurs de saisie (sauf celles de stock mais bon c'est vous qui vous trompez en comptant).</p>

            <!-- Infos -->
            <h2 class="sub-title">Infos</h2>
            <p class="text">Pour acc√©der √† PhpMyAdmin, les liens sont dans la fiche fournisseur de INOVEA Conseil (<a href="https://ecid.dolibiz.net/societe/note.php?id=1842">lien vers la fiche</a>).</p>
            <p class="text">Toutes les mor√ßeaux de code/requ√™tes ci-dessus doivent √™tre effectu√©es dans l‚Äôonglet SQL de PhpMyAdmin (en haut √† gauche).</p>
            <img src="/static/img/inventaire/1.png" alt="Ou trouver l'onglet SQL">
            <p class="text">Dans la suite, les tables sont indiqu√©es avec un nom de cette forme ‚Äúecid_erp.llx_product‚Äù, ecid_erp correspond √† la base de donn√©es que la version production utilise et llx_product est la table des produits enregistr√©s dans Dolibarr.</p>
            <p class="text">Si vous souhaitez faire un test pour la mise √† jour du stock avant de le faire sur la version de production, le test peut √™tre fait dans ‚Äúecid_mig‚Äù qui est la base de donn√©es de la version de pr√©-production. </p>
            <img src="/static/img/inventaire/2.png" alt="BDD existantes">
            <!-- D√©roulement -->
            <h2 class="sub-title">D√©roulement</h2>
            <p class="text">Le but ici est de r√©cup√©rer d‚Äôabord la valeur de stock dans la table ecid_erp.llx_product, la mettre √† jour en fonction du vrai stock dans le hangar puis d‚Äôimporter les nouvelles valeurs dans une table ecid_erp.llx_product_tmp que l‚Äôon va cr√©er et enfin d‚Äôutiliser cette table pour mettre √† jour la valeur de reel dans ecid_erp.llx_product_stock qui est la vraie valeur du stock affich√©e dans Dolibarr (pour cette derni√®re √©tape, on met √©galement √† jour la valeur de stock que l‚Äôon a r√©cup√©r√©e au d√©but pour aligner les valeurs entre elles qui est normalement fait automatiquement par Dolibarr).</p>
            <p class="text">La proc√©dure vise √† mettre √† jour la valeur de stock dans la table llx_product qui est le quantit√© stock√© du produit dans tous les entrepots et la valeur de reel dans llx_product_stock qui est la quantit√© de stock en fonction de l‚Äôentrepot.</p>
            <p class="text">Puisqu‚Äôon utilise un seul entrep√¥t, on peut modifier uniquement ces deux valeurs et tout sera bon dans Dolibarr.</p>
            <p class="text">Pour ce qui est du stock virtuel, pas de valeur √† modifier, il est toujours calcul√© dynamiquement en fonction de la valeur de reel et des quantit√©s dans les commandes clients et fournisseurs donc sa valeur sera juste si celle de reel est juste.</p>

            <!-- Pr√©lude -->
            <h2 class="sub-title">Pr√©lude</h2>
            <p class="text">Si vous souhaitez mettre le stock √† 0 avant de faire l‚Äôinventaire, le code suivant met le stock de tous les produits √† 0 mais ce n‚Äôest pas une √©tape obligatoire :</p>
            <p class="code text"><code>UPDATE ecid_erp.llx_product AS p <br>SET p.stock = 0;<br>UPDATE ecid_erp.llx_product_stock AS p_s <br>SET p_s.reel = 0;</code></p>
            <p class="text">La requ√™te suivante permet de voir si le stock a bien √©t√© mis √† 0:</p>
            <p class="text code"><code>SELECT p.label, p.stock, p_s.reel FROM ecid_erp.llx_product AS p<br>JOIN ecid_erp.llx_product_stock AS p_s ON p_s.fk_product = p.rowid</code></p>

            <!-- Protocole -->
            <!-- Exporter les donn√©es depuis PhpMyAdmin -->
            <h2 class="sub-title">Exporter les produits √† l‚Äôaide de PhpMyAdmin</h2>
            <p class="text">Pour cela, on va dans la table dolibarr.llx_product avec la ligne suivante qui permet d‚Äôavoir le produit avec sa r√©f, son libell√©, son stock, son dernier prix d‚Äôachat avec la remise sur la commande li√©e:</p>
            <p class="text code"><code>SELECT p.rowid, p.ref, p.label, p.stock, c_f.subprice, c_f.remise_percent FROM ecid_erp.llx_product AS p<br>JOIN ecid_erp.llx_commande_fournisseurdet AS c_f ON c_f.fk_product = p.rowid<br>JOIN ecid_erp.llx_commande_fournisseur AS c ON c_f.fk_commande = c.rowid<br>WHERE c.date_creation = (SELECT max(c_bis.date_creation) FROM ecid_erp.llx_commande_fournisseur as c_bis JOIN ecid_erp.llx_commande_fournisseurdet as cf_bis on cf_bis.fk_commande = c_bis.rowid WHERE cf_bis.fk_product = p.rowid)<br>GROUP BY p.rowid</code></p>
            <p class="text">La remise est en pourcent dans la colonne remise_percent.</p>
            <p class="text">Avec le r√©sultat obtenu, il faut descendre jusqu‚Äôen bas de la page et aller sur ‚ÄúExporter‚Äù .</p>
            <img src="/static/img/inventaire/3.png" alt="Ou trouver Exporter">
            <p class="text">Dans l‚Äôexportation, choisir Personnalis√©e pour la m√©thode d‚Äôexportation, choisir le format OpenDocument Spreadsheet (les autres formats peuvent cr√©er des probl√®mes lors de l‚Äôexport), cocher  ‚ÄúAfficher les noms de colonnes en premi√®re ligne‚Äù puis Exporter.</p>
            <img src="/static/img/inventaire/4.png" alt="Personnaliser l'export">
            <p class="text">Enregistrez le fichier sous le nom donn√© (llx_product).</p>

            <!-- V√©rification du stock r√©el -->
            <h2 class="sub-title">Editer le stock pendant l‚Äôinventaire</h2>
            <p class="text">Avant d‚Äô√©diter le stock, v√©rifiez que la premi√®re ligne contient le nom des colonnes sinon, l‚Äôimport sera infaisable, il faudra refaire l‚Äôexport et recommencez l‚Äôinventaire (ou du moins remodifiez les valeurs de stock de chaque produit).</p>
            <p class="text">Maintenant que tout est bon, on peut √©diter la colonne stock dans Excel ou logiciel √©quivalent pendant l‚Äôinventaire.</p>
            <p class="text">Le mieux est d‚Äô√©diter seulement la colonne stock pour faciliter l‚Äôimport mais tant que la colonne rowid ne change pas, l‚Äôimport devrait bien se passer.</p>
            <p class="text">A pr√©sent, il faut renommer la feuille de calcul dans le fichier (en bas √† gauche sur image) sinon phpMyAdmin va refuser l‚Äôimport :</p>
            <img src="/static/img/inventaire/5.png" alt="Renommage de la feuille de calcul">
            <p class="text">Puis enregister le fichier sous le m√™me nom que la feuille de calcul au format OpenDocument:</p>
            <img src="/static/img/inventaire/6.png" alt="Enregistrement sous le bon nom">

            <!-- Import dans Dolibarr -->
            <h2 class="sub-title">Importation des donn√©es dans PhpMyAdmin</h2>
            <p class="text">Pour importer les donn√©es, il faut aller dans Import de PhpMyAdmin en √©tant dans la base de donn√©es de ecid_erp.</p>
            <img src="/static/img/inventaire/7.png" alt="Dans quelle base importer">
            <p class="text">Choisir le fichier contenant les corrections de stock. V√©rifier que le format est bien OpenDocument Spreadsheet, cocher ‚ÄúLa premi√®re ligne du fichier contient le nom des colonnes‚Äù puis Importer.</p>
            <img src="/static/img/inventaire/8.png" alt="Format du document">
            <p class="text">A partir d‚Äôici la table est cr√©√©e en fonction du nom qu‚Äôil lui a √©t√© donn√© dans le fichier Excel, si la feuille de calcul a √©t√© appel√©e autrement que llx_product_tmp, il faut changer les requ√™tes suivantes en remplacant llx_product_tmp par le nom donn√©.</p>
            <p class="text">V√©rifier que la nouvelle table a √©t√© cr√©√©e avec le code :</p>
            <p class="text code"><code>SELECT * FROM ecid_erp.llx_product_tmp</code></p>
            <p class="text">Si tout semble bon, essayer le code suivant pour v√©rifier que les tables arrivent √† se lier : </p>
            <p class="text code"><code>SELECT tmp.ref, tmp.label, p_s.reel AS ancien_stock, tmp.stock AS nv_stock<br>FROM ecid_erp.llx_product AS p <br>JOIN ecid_erp.llx_product_tmp AS tmp ON p.rowid = tmp.rowid<br>JOIN ecid_erp.llx_product_stock AS p_s ON p.rowid = p_s.fk_product</code></p>
            <p class="text">Le code devrait afficher la ref du produit avec son nom, son stock avant la v√©rif dans entrepot (0 si toutes les valeurs ont √©t√© mises √† 0 avant) et le stock not√© lors de l‚Äôinventaire.</p>
            <img src="/static/img/inventaire/9.png" alt="R√©sultat de l'import dans la BDD">
            <p class="text">Si le code se fait sans probl√®me, il fait maintenant utiliser la table tmp pour mettre √† jour la table des produits. Pour cela, on utilise le code suivant : </p>
            <p class="text code"><code>UPDATE ecid_erp.llx_product_stock as p_s<br>JOIN ecid_erp.llx_product_tmp AS tmp on p_s.fk_product = tmp.rowid<br>SET p_s.reel = tmp.stock;<br>UPDATE ecid_erp.llx_product as p <br>JOIN ecid_erp.llx_product_stock as p_s on p_s.fk_product = p.rowid<br>SET p.stock = p_s.reel</code></p>
            <p class="text">Pour v√©rifier que le stock a bien √©t√© modifi√©:</p>
            <p class="text code"><code>SELECT p.ref, p.label, p.stock, p_s.reel FROM ecid_erp.llx_product AS p<br>JOIN ecid_erp.llx_product_stock AS p_s ON p.rowid = p_s.fk_product</code></p>
            <p class="text">Il est normal que certains produits apparaissent avec un stock NULL lors de cette derni√®re requ√™te, il s‚Äôagit de produits qui n‚Äôont jamais √©t√© en stock ou de mouvements de stock (par exemple, les produits qui sont r√©pertori√©s mais qui n‚Äôont jamais √©t√© vendus ou achet√©s).</p>
            <img src="/static/img/inventaire/10.png" alt="Import et mise √† jour du stock r√©ussis">
            <p class="text">Une fois que tout est bon, on peut effacer la table utilis√©e pour la modification:</p>
            <p class="text code">DROP TABLE ecid_erp.llx_product_tmp</p>
            <p class="text">Et voil√† le stock est √† jour üëë</p>
        </div>
        <p class="text">T√©l√©chargez ce document au format PDF : <a href="/static/doc/inventaire_debut_d_annee.pdf">PDF</a></p>
    </body>
</html>